---
name: 'Deploy'
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Host"
        required: true
        default: "mash.gluecode.dev"
        type: choice
        options:
          - mash.gluecode.dev

      dry_run:
        description: "Nur testen?"
        required: false
        type: boolean
        default: true

jobs:
  action:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: alex-oleshkevich/setup-ansible@v1.0.1
        with:
          version: "12.2.0"
      - run: python -m pip install regex passlib
      - name: Download and install agru
        run: |
          curl -L \
            https://github.com/etkecc/agru/releases/download/v0.1.18/agru_Linux_x86_64.tar.gz \
            -o agru_Linux_x86_64.tar.gz
          tar -xzf agru_Linux_x86_64.tar.gz
          chmod +x agru
          echo "$PWD" >> "$GITHUB_PATH"
      - uses: extractions/setup-just@v3
      - uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON(secrets) }}
      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Optional: known_hosts damit SSH nicht interaktiv fragt
          ssh-keyscan -H mash.gluecode.dev >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
      - run:  just optimize
      - run:  just roles
      - run:  ANSIBLE_HOST_KEY_CHECKING=False just setup-all